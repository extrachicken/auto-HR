# 1. Автоматическое создание Typeform из описания вакансии

## Введение

Этот проект предназначен для автоматического создания форм Typeform на основе описания вакансии и списка обязательных качеств (must-haves). Он использует API OpenAI для генерации вопросов, API Typeform для создания форм и Google Sheets для хранения данных о вакансиях. Цель проекта — упростить процесс создания форм для найма, автоматизируя генерацию вопросов и интеграцию с популярными сервисами.

## Основные функции

- **Чтение данных из Google Sheets**: Проект извлекает описание вакансии и список обязательных качеств из указанной строки в Google Sheets.
- **Генерация вопросов с помощью OpenAI**: На основе описания вакансии создаются вопросы для формы с использованием модели GPT-4.
- **Обработка обязательных качеств**: Формируются вопросы по must-haves, включая логику для обработки ожиданий по зарплате.
- **Создание формы в Typeform**: Все части формы (вопросы по описанию вакансии, must-haves и стандартные поля) объединяются и отправляются через Typeform API.
- **Запись данных в Google Sheets**: Сгенерированные вопросы и ссылка на форму сохраняются обратно в Google Sheets.

## Структура проекта

Проект состоит из следующих модулей:

- **`sheets_utils.py`**: Функции для работы с Google Sheets (чтение данных из строк, запись значений в ячейки).
- **`settings.py`**: Конфигурационные параметры (имена листов, идентификаторы столбцов, ключи API и т.д.).
- **`constants_json.py`**: Генерация стандартных полей формы (имя, email, телефон) и экранов благодарности с редиректом.
- **`gpt_json.py`**: Генерация вопросов по описанию вакансии с использованием OpenAI API.
- **`must_haves_json.py`**: Создание вопросов по обязательным качествам и логики для обработки ответов о зарплате.
- **`main_typeform.py`**: Основной модуль, который собирает JSON для Typeform и отправляет его в API.

## Установка и настройка

1. **Установите необходимые библиотеки**:
   ```bash
   pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2 openai requests flask
   ```

2. **Настройте учетные данные**:
   - Получите учетные данные для Google Sheets API и сохраните их в файл `creds.json`.
   - Укажите API ключи для OpenAI и Typeform в переменных окружения или в `settings.py`.

3. **Настройте Google Sheets**:
   - Убедитесь, что у вас есть доступ к Google Sheets с данными.
   - Укажите имена листов и идентификаторы столбцов в `settings.py`.

4. **Настройте Typeform**:
   - Проверьте доступ к Typeform API и укажите правильный API ключ в `settings.py`.

## Использование

1. **Запустите главный скрипт**:
   ```bash
   python main_typeform.py
   ```

2. **Передайте параметры**:
   - Укажите `row_id` как параметр запроса, чтобы выбрать строку в Google Sheets.
   - Пример: `http://localhost:5000/?row_id=2`

3. **Получите результат**:
   - Проект прочитает данные из строки, сгенерирует вопросы, создаст форму в Typeform и сохранит результаты в Google Sheets.
   - В ответе вы получите JSON с информацией о созданной форме.

## Пример

### Запрос

```
GET /?row_id=2
```

### Ответ

```json
{
  "ok": true,
  "form_url": "https://your-typeform-url",
  "questions_written_to": "G2",
  "form_link_written_to": "H2"
}
```

### Объяснение

- **`form_url`**: Ссылка на созданную форму в Typeform.
- **`questions_written_to`**: Ячейка с записанными вопросами (например, G2).
- **`form_link_written_to`**: Ячейка с записанной ссылкой на форму (например, H2).


# 2. Логика валидации для Typeform

## Введение

Этот модуль обрабатывает данные, отправленные из формы Typeform, выполняет финальную валидацию ответов кандидата на соответствие обязательным требованиям (must-haves) и перенаправляет пользователя на страницу успеха или отказа в зависимости от результатов. Он интегрируется с формой, созданной в первой части проекта, и обеспечивает автоматическую проверку соответствия кандидата требованиям вакансии.

## Основные функции

- **`extract_form_data(url_params)`**: Извлекает данные из URL-параметров, переданных Typeform, и преобразует их в удобный для обработки словарь.
- **`validate_must_haves(must_haves_text, form_data)`**: Проверяет, соответствуют ли ответы кандидата обязательным требованиям (must-haves). Особое внимание уделяется требованиям по бюджету, которые обрабатываются через поле `budget_accept`.
- **`process_submission(request)`**: Основная функция, которая принимает запрос от Typeform, извлекает данные, выполняет валидацию и перенаправляет кандидата на соответствующую страницу (успех или отказ).

## Установка и настройка

1. **Зависимости**:
   Убедитесь, что все необходимые библиотеки установлены. Список зависимостей находится в `requirements.txt`:
   - `flask>=2.0.0`
   - `openai>=1.0.0`
   - `requests>=2.25.0`
   - `google-cloud-bigquery`
   - `openpyxl`
   - `python-dotenv>=0.19.0`
   - `google-auth>=2.0.0`
   - `google-api-python-client>=2.0.0`

   Установите их с помощью команды:
   ```bash
   pip install -r requirements.txt
   ```

2. **Настройка окружения**:
   Убедитесь, что следующие переменные окружения настроены в `settings.py` или через системные переменные:
   - `GOOGLE_SHEET_ID`: ID вашей Google Sheets таблицы.
   - `OPENAI_API_KEY`: Ключ API для OpenAI.
   - `TYPEFORM_API_KEY`: Ключ API для Typeform.
   - `SUCCESS_URL`: URL страницы успеха (по умолчанию: Google Docs ссылка).
   - `FAIL_URL`: URL страницы отказа (по умолчанию: Google Docs ссылка).

3. **Настройка Cloud Function**:
   Этот модуль предназначен для развертывания как Google Cloud Function. Убедитесь, что:
   - У вас есть доступ к проекту Google Cloud (по умолчанию: `qalearn`).
   - Cloud Function настроена для обработки HTTP-запросов с использованием `main.py`.

## Использование

1. **Триггер**:
   Модуль активируется при получении HTTP-запроса от Typeform после завершения заполнения формы. Typeform передает данные через URL-параметры.

2. **Обработка данных**:
   - Функция `process_submission` извлекает данные из запроса.
   - Проверяются обязательные параметры (например, `pass`).
   - Выполняется валидация must-haves с использованием `validate_must_haves`.

3. **Перенаправление**:
   - Если все must-haves выполнены, кандидат перенаправляется на `SUCCESS_URL`.
   - Если хотя бы одно требование не выполнено, кандидат перенаправляется на `FAIL_URL`.

## Пример

### Запрос от Typeform
Предположим, Typeform отправляет следующий запрос:

```
GET /process_submission?pass=true&must_haves=Опыт работы с Python%0AБюджет 100000 руб.&field:musthave_1=yes&field:budget_accept=yes&field:email=test@example.com&field:phone=1234567890&field:name=John Doe
```

### Обработка
1. **Извлечение данных**:
   - `pass=true`
   - `must_haves="Опыт работы с Python\nБюджет 100000 руб."`
   - `form_data = {"musthave_1": "yes", "budget_accept": "yes", "email": "test@example.com", "phone": "1234567890", "name": "John Doe"}`

2. **Валидация must-haves**:
   - "Опыт работы с Python" проверяется через `musthave_1`. Ответ "yes" — требование выполнено.
   - "Бюджет 100000 руб." проверяется через `budget_accept`. Ответ "yes" — требование выполнено.

3. **Перенаправление**:
   - Все must-haves выполнены, кандидат перенаправляется на `SUCCESS_URL`.


## Обработка ошибок и логирование

- **Логирование**:
   Используется модуль `logging` для записи событий:
   - Информационные сообщения (например, "Кандидат прошел финальную валидацию").
   - Предупреждения (например, "Отсутствуют must-have параметры").
   - Ошибки (например, "Ошибка обработки данных: ...").
   У   - Уровень логирования настраивается через переменную окружения `LOG_LEVEL` (по умолчанию: `INFO`).

- **Обработка ошибок**:
   - Если отсутствуют обязательные параметры (например, `pass`), возвращается JSON с ошибкой и кодом состояния 400.
   - При возникновении исключений возвращается JSON с описанием ошибки и кодом состояния 500.

## Дополнительные замечания

- **Настройка URL**: Убедитесь, что `PROCESS_SUBMISSION_URL` (по умолчанию: `https://us-central1-qalearn.cloudfunctions.net/process_submission`) указан в настройках формы Typeform для корректной передачи данных.
- **Безопасность**: Данные передаются через URL, поэтому избегайте передачи чувствительной информации в открытом виде.
